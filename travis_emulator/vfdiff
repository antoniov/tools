#! /bin/bash
# -*- coding: utf-8 -*-
# Version file diff
# Make diff of file among Odoo versions
#
# author: Antonio M. Vigliotti - antoniomaria.vigliotti@gmail.com
# (C) 2015-2016 by SHS-AV s.r.l. - http://www.shs-av.com - info@shs-av.com
# This free software is released under GNU Affero GPL3
THIS=$(basename $0)
TDIR=$(readlink -f $(dirname $0))
for x in "$TDIR" "$TDIR/.." "." ".." "~" "/etc"; do
  if [ -e $x/z0librc ]; then
    . $x/z0librc
    Z0LIBDIR=$x
    Z0LIBDIR=$(readlink -e $Z0LIBDIR)
    break
  fi
done
if [ -z "$Z0LIBDIR" ]; then
  echo "Library file z0librc not found!"
  exit 2
fi

__version__="0.1.8"


get_odoo_ver() {
  local i=
  local v=
  local p=$1
  if [ -z "$1" ]; then
    p=$PWD
  fi
  for i in {2..4}; do
    local t=$(echo "$p"|awk -F/ '{ print $'$i'}')
    if [ -z "$t" ]; then
      break
    elif [[ " 10.0 9.0 8.0 7.0 " =~ [[:space:]]$t[[:space:]] ]]; then
      local v=$t
      break
    elif [[ " v10 v9 v8 v7 " =~ [[:space:]]$t[[:space:]] ]]; then
      local v=${t:1}.0
      break
    fi
  done
  echo "$v"
}

get_name_zeroincombenze() {
# get_name_zeroincombenze(name odoo_ver)
    if [ "$1" == "zeroincombenze" ]; then
      if [[ " 10.0 9.0 8.0 7.0 " =~ [[:space:]]$2[[:space:]] ]]; then
        result="$result/l10n-italy-supplemental"
      else
        result="$result/$1"
      fi
      if [ -z "$opt_rep" ]; then
        opt_rep=l10n-italy-supplemental
      fi
      msts=2
    fi
}

get_name_supplemental() {
# get_name_zeroincombenze(name odoo_ver)
    if [ "$1" == "l10n-italy-supplemental" ]; then
      if [[ " v10 v9 v8 v7 " =~ [[:space:]]$2[[:space:]] ]]; then
        result="$result/zeroincombenze"
      else
        result="$result/$1"
      fi
      if [ -z "$opt_rep" ]; then
        opt_rep=$1
      fi
      msts=2
    fi
}

get_path_ver() {
# get_path_ver(path odoo_ver rep pkg)
  result=
  msts=0
  local i=
  local ov=$2
  local r=$1
  local re="(10\.0|9\.0|8\.0|7\.0|v10|v9|v8|v7)"
  if [ -z "$r" ]; then
    r=/opt/odoo
  elif [ "${r:0:1}" != "/" -a "${r:0:1}" != "~" ]; then
    r=/opt/odoo/$r
  fi
  for i in {2..9}; do
    local t=$(echo "$r"|awk -F/ '{ print $'$i'}')
    if [ -z "$t" ]; then
      break
    elif [ $msts -eq 0 ] && [[ $t =~ $re ]]; then
      result="$result/$t"
      ov=$t
      msts=1
    elif [ "$t" == "zeroincombenze" ]; then
      get_name_zeroincombenze "$t" "$ov"
    elif [ "$t" == "l10n-italy-supplemental" ]; then
      get_name_supplemental "$t" "$ov"
    else
      result="$result/$t"
      if [ $msts -eq 1 ]; then
        if [ -z "$opt_rep" ]; then
          opt_rep=$t
        fi
        msts=2
      elif [ $msts -eq 2 ]; then
        if [ -z "$opt_pkg" ]; then
          opt_pkg=$t
        fi
        msts=3
      elif [ $msts -eq 3 ]; then
        if [ -z "$opt_fn" ]; then
          opt_fn=$t
        fi
        msts=4
      fi
    fi
  done
  if [ $msts -eq 0 ]; then
    result="$result/$ov"
    msts=1
  fi
  if [ $msts -eq 1 ]; then
    if [ "$3" == "zeroincombenze" ]; then
      get_name_zeroincombenze "$3" "$ov"
    elif [ "$3" == "l10n-italy-supplemental" ]; then
      get_name_supplemental "$3" "$ov"
    elif [ -n "$3" ]; then
      result="$result/$3"
      msts=2
    elif [ -n "$opt_rep" ]; then
      result="$result/$opt_rep"
      msts=2
    fi
  fi
  if [ $msts -eq 2 ]; then
    if [ -n "$4" ]; then
      result="$result/$4"
      msts=3
    elif [ -n "$opt_pkg" ]; then
      result="$result/$opt_pkg"
      msts=3
    fi
  fi
  if [ $msts -eq 3 ]; then
    if [ -n "$opt_fn" ]; then
      result="$result/$opt_fn"
      msts=4
    fi
  fi
}

OPTOPTS=(h        n            O         p         r            V           v           y)
OPTDEST=(opt_help opt_dry_run  odoo_ver  opt_pkg   opt_rep      opt_version opt_verbose opt_para)
OPTACTI=(1        "1"          "="       "="       "="          "*>"        1           1)
OPTDEFL=(0        0            ""        ""        ""           ""          0           0)
OPTMETA=("help"   "do nothing" "version" "package" "repository" "version"   "verbose"   "parall")
OPTHELP=("this help"\
 "do nothing (dry-run)"\
 "select target Odoo version (may be 7, 8, 9 o 10)"\
 "select package name"\
 "select repository name"\
 "show version"\
 "verbose mode"\
 "side by side")
OPTARGS=(source target)

parseoptargs "$@"
if [ "$opt_version" ]; then
  echo "$__version__"
  exit 0
fi
if [ -z "$odoo_ver" -a -z "$source" ]; then
  opt_help=1
fi
if [ $opt_help -gt 0 ]; then
  print_help "Diff file between Odoo versions"\
  "(C) 2015-2016 by zeroincombenze(R)\nhttp://wiki.zeroincombenze.org/en/Odoo/dev\nAuthor: antoniomaria.vigliotti@gmail.com"
  exit 0
fi
# set -x
if [[ " 10 9 8 7 " =~ [[:space:]]$odoo_ver[[:space:]] ]]; then
  odoo_ver="$odoo_ver.0"
fi
cv=$(get_odoo_ver)
if [ -z "$source" ]; then
  filenames=$PWD
  ovs=$cv
else
  filenames=$(readlink -f $source)
  ovs=$(get_odoo_ver $source)
fi
if [ -z "$target" ]; then
  filenamet=
  ovt=$odoo_ver
elif [ "${target:0:1}" == "/" -o "${target:0:1}" == "~" ]; then
  filenamet=$(readlink -f $target)
  ovt=$odoo_ver
else
  filenamet=$target
  ovt=$(get_odoo_ver $target)
fi
if [ -z "$ovt" ]; then
  ovt=$ovs
fi
get_path_ver "$filenames" "$ovs" "$opt_rep" "$opt_pkg"
filenames=$result
get_path_ver "$filenamet" "$ovt" "$opt_rep" "$opt_pkg"
filenamet=$result
if [ -d "$filenames" ]; then
  opts="-x*.pyc -x*.po* -x*.bak -x*~ -qr"
else
  if [ $opt_para -ne 0 ]; then
    opts=-y
  else
    opts=
  fi
fi
if [ $opt_verbose -gt 0 ]; then
  echo "diff $opts $filenames $filenamet"
fi
if [ $opt_dry_run -eq 0 ]; then
  diff $opts $filenames $filenamet
fi
